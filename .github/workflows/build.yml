name: Build

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        type: boolean
        required: false
        default: false
      debug_os:
        description: 'which runner os to run the tmate action in (if the tmate action is run)'
        type: string
        default: 'windows-latest'
        required: false
      debug_detached:
        description: 'whether to launch tmate in detached mode (if the tmate action is run)'
        type: boolean
        required: false
        default: true
      llvm_commit:
        description: 'llvm commit to build'
        type: string
        required: false
        default: ''

  schedule:
    # At minute 0 past hour 1, 7, 13, and 19. (see https://crontab.guru)
    - cron: '00 01,07,13,19 * * *'

jobs:

  get_llvm_project_commit:
    name: Get latest LLVM commit
    runs-on: ubuntu-latest
    outputs:
      LLVM_PROJECT_COMMIT: ${{ steps.get_llvm_project_commit.outputs.LLVM_PROJECT_COMMIT }}
    steps:
      - name: Get llvm-project commit
        id: get_llvm_project_commit
        run: |
          if [ x"${{ inputs.llvm_commit }}" == x"" ]; then
            sudo apt install jq
            LLVM_PROJECT_COMMIT=$(curl -s https://api.github.com/repos/llvm/llvm-project/commits/main | jq -r '.sha[:8]')
          else
            LLVM_PROJECT_COMMIT="${{ inputs.llvm_commit }}"
          fi
          echo "LLVM_PROJECT_COMMIT=${LLVM_PROJECT_COMMIT}" | tee -a $GITHUB_OUTPUT

  build:

    needs: get_llvm_project_commit

    name: Build distro of LLVM+MLIR
    #    runs-on: ${{ (matrix.os == 'windows-latest' && 'self-hosted') || matrix.os }}
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-20.04, macos-latest, windows-latest ]
        arch: [ AArch64, X86 ]
        py_version: [ "3.11" ]
    outputs:
      LLVM_PROJECT_COMMIT: ${{ needs.get_llvm_project_commit.outputs.LLVM_PROJECT_COMMIT }}

    steps:
      - name: Set up Python
        uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # v4.3.0
        with:
          python-version: ${{ matrix.py_version }}

      - uses: ilammy/msvc-dev-cmd@v1.4.1

# chocolatey vswhere
# choco install powershell-core -> add pwsh.exe to path
# choco install git and add bash.exe to path

      - name: Set up Visual Studio shell
        if: ${{ matrix.os == 'windows-latest' }}
        uses: egor-tensin/vs-shell@v2
        with:
          arch: x64

      - name: MS Build
        if: ${{ matrix.os == 'windows-latest' }}
        uses: microsoft/setup-msbuild@v1.1

      # Enable tmate debugging of manually-triggered workflows if the input option was provided
      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled && inputs.debug_os == matrix.os }}
        with:
          limit-access-to-actor: true
          detached: ${{ inputs.debug_detached }}

      - name: Set workspace root
        shell: bash
        run: |
          if [ x"${{ matrix.os }}" == x"windows-latest" ]; then
            mkdir -p /C/a
            echo "WORKSPACE_ROOT=/C/a" | tee -a $GITHUB_ENV
          else
            echo "WORKSPACE_ROOT=${GITHUB_WORKSPACE}" | tee -a $GITHUB_ENV
          fi

      - name: Checkout llvm-project
        shell: bash
        run: |
          cd $WORKSPACE_ROOT
          if [ ! -d "llvm-project" ]; then
            git clone https://github.com/llvm/llvm-project.git
          fi 
          cd llvm-project && git reset --hard ${{ inputs.llvm_commit }}

      - name: Compute llvm-project base path and output commit
        shell: bash
        run: |
          echo "LLVM_PROJECT_MAIN_SRC_DIR=${WORKSPACE_ROOT}/llvm-project" | tee -a $GITHUB_ENV
          echo "LLVM_PROJECT_MAIN_BINARY_DIR=${WORKSPACE_ROOT}/build" | tee -a $GITHUB_ENV
          echo "LLVM_PROJECT_INSTALL_DIR=${WORKSPACE_ROOT}/llvm_project_install" | tee -a $GITHUB_ENV
          echo "LLVM_PROJECT_HOST_MAIN_BINARY_DIR=${WORKSPACE_ROOT}/build_host" | tee -a $GITHUB_ENV
          echo "LLVM_PROJECT_COMMIT=${{ needs.get_llvm_project_commit.outputs.LLVM_PROJECT_COMMIT }}" | tee -a $GITHUB_ENV

      - name: Install Python depends
        shell: bash
        run: |
          python -m pip install -r ${LLVM_PROJECT_MAIN_SRC_DIR}/mlir/python/requirements.txt

      - name: Install Ninja
        uses: llvm/actions/install-ninja@6a57890d0e3f9f35dfc72e7e48bc5e1e527cdd6c # Jan 17

      - name: Ccache for C++ compilation
        uses: hendrikmuhs/ccache-action@621a41397ed83711c72862638d9ff6e63fca3041 # v1.2.3
        with:
          key: ${{ matrix.os }}-${{ matrix.arch }}-llvm-project
          # LLVM needs serious cache size
          max-size: 6G

      - name: Install cross-compilation toolchain
        if: ${{ matrix.os == 'ubuntu-20.04' && matrix.arch == 'AArch64' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y binutils-aarch64-linux-gnu \
            g++-aarch64-linux-gnu gcc-aarch64-linux-gnu

      - name: Choose compiler and set env vars
        shell: bash
        run: |
          if [ x"${{ matrix.os }}" == x"macos-latest" ] && [ x"${{ matrix.arch }}" == x"AArch64" ]; then
            echo "ARCH=AArch64" | tee -a $GITHUB_ENV
            echo "CXX_COMPILER=clang++" | tee -a $GITHUB_ENV
            echo "C_COMPILER=clang" | tee -a $GITHUB_ENV
            echo "LLVM_DEFAULT_TARGET_TRIPLE=arm64-apple-darwin21.6.0" | tee -a $GITHUB_ENV
            echo "LLVM_HOST_TRIPLE=arm64-apple-darwin21.6.0" | tee -a $GITHUB_ENV
            echo "GENERATOR=Ninja" | tee -a $GITHUB_ENV
            echo "CMAKE_OSX_ARCHITECTURE=arm64" | tee -a $GITHUB_ENV
          elif [ x"${{ matrix.os }}" == x"macos-latest" ] && [ x"${{ matrix.arch }}" == x"X86" ]; then
            echo "ARCH=X86" | tee -a $GITHUB_ENV
            echo "CXX_COMPILER=clang++" | tee -a $GITHUB_ENV
            echo "C_COMPILER=clang" | tee -a $GITHUB_ENV
            echo "LLVM_DEFAULT_TARGET_TRIPLE=x86_64-apple-darwin" | tee -a $GITHUB_ENV
            echo "LLVM_HOST_TRIPLE=x86_64-apple-darwin" | tee -a $GITHUB_ENV
            echo "GENERATOR=Ninja" | tee -a $GITHUB_ENV
            echo "CMAKE_OSX_ARCHITECTURE=x86_64" | tee -a $GITHUB_ENV
          elif [ x"${{ matrix.os }}" == x"windows-latest" ] && [ x"${{ matrix.arch }}" == x"X86" ]; then
            echo "ARCH=X86" | tee -a $GITHUB_ENV
            echo "CXX_COMPILER=cl" | tee -a $GITHUB_ENV
            echo "C_COMPILER=cl" | tee -a $GITHUB_ENV
            echo "LLVM_DEFAULT_TARGET_TRIPLE=x86_64-windows-msvc" | tee -a $GITHUB_ENV
            echo "LLVM_HOST_TRIPLE=x86_64-windows-msvc" | tee -a $GITHUB_ENV
            echo "STATIC_FLAGS=" | tee -a $GITHUB_ENV
            echo "GENERATOR=Ninja" | tee -a $GITHUB_ENV
          elif [ x"${{ matrix.os }}" == x"windows-latest" ] && [ x"${{ matrix.arch }}" == x"AArch64" ]; then
            echo "ARCH=AArch64" | tee -a $GITHUB_ENV
            echo "CXX_COMPILER=cl" | tee -a $GITHUB_ENV
            echo "C_COMPILER=cl" | tee -a $GITHUB_ENV
            echo "LLVM_DEFAULT_TARGET_TRIPLE=arm64-windows-msvc" | tee -a $GITHUB_ENV
            echo "LLVM_HOST_TRIPLE=arm64-windows-msvc" | tee -a $GITHUB_ENV
            echo "STATIC_FLAGS=" | tee -a $GITHUB_ENV
            echo "GENERATOR=Visual Studio 17 2022" | tee -a $GITHUB_ENV
          elif [ x"${{ matrix.os }}" == x"ubuntu-20.04" ] && [ x"${{ matrix.arch }}" == x"AArch64" ]; then
            echo "ARCH=AArch64" | tee -a $GITHUB_ENV
            echo "CXX_COMPILER=aarch64-linux-gnu-g++" | tee -a $GITHUB_ENV
            echo "C_COMPILER=aarch64-linux-gnu-gcc" | tee -a $GITHUB_ENV
            echo "LLVM_DEFAULT_TARGET_TRIPLE=aarch64-linux-gnu" | tee -a $GITHUB_ENV
            echo "LLVM_HOST_TRIPLE=aarch64-linux-gnu" | tee -a $GITHUB_ENV
            echo "STATIC_FLAGS=-static-libgcc -static-libstdc++" | tee -a $GITHUB_ENV
            echo "GENERATOR=Ninja" | tee -a $GITHUB_ENV
          else
            echo "ARCH=X86" | tee -a $GITHUB_ENV
            echo "CXX_COMPILER=g++" | tee -a $GITHUB_ENV
            echo "C_COMPILER=gcc" | tee -a $GITHUB_ENV
            echo "LLVM_DEFAULT_TARGET_TRIPLE=x86_64-unknown-linux-gnu" | tee -a $GITHUB_ENV
            echo "LLVM_HOST_TRIPLE=x86_64-unknown-linux-gnu" | tee -a $GITHUB_ENV
            echo "STATIC_FLAGS=-static-libgcc -static-libstdc++" | tee -a $GITHUB_ENV
            echo "GENERATOR=Ninja" | tee -a $GITHUB_ENV
          fi

      - name: Build host llvmtblgen/mlirtblgen
        if: ${{ matrix.arch == 'AArch64' }}
        shell: bash
        run: |
          cd $WORKSPACE_ROOT
          if [ x"${{ matrix.os }}" == x"ubuntu-20.04" ]; then
            export CXX_COMPILER=g++
            export C_COMPILER=gcc
          fi
          cmake \
            -G Ninja \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=$CXX_COMPILER \
            -DCMAKE_CXX_FLAGS="-O2 ${STATIC_FLAGS}" \
            -DCMAKE_C_COMPILER=$C_COMPILER \
            -DLLVM_ENABLE_PROJECTS=mlir \
            -DLLVM_ENABLE_TERMINFO=OFF \
            -DLLVM_ENABLE_ZLIB=OFF \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DLLVM_TARGETS_TO_BUILD=X86 \
            -S${LLVM_PROJECT_MAIN_SRC_DIR}/llvm \
            -B${LLVM_PROJECT_HOST_MAIN_BINARY_DIR}
          
          cmake --build ${LLVM_PROJECT_HOST_MAIN_BINARY_DIR} \
            --target llvm-tblgen mlir-tblgen mlir-linalg-ods-yaml-gen mlir-pdll -j 20

      - name: Configure CMake
        shell: bash
        run: |
          cd $WORKSPACE_ROOT
          CMAKE_CONFIGS="\
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=$CXX_COMPILER \
            -DCMAKE_C_COMPILER=$C_COMPILER \
            -DCMAKE_INSTALL_PREFIX=$LLVM_PROJECT_INSTALL_DIR \
            -DLLVM_CCACHE_BUILD=ON \
            -DLLVM_DEFAULT_TARGET_TRIPLE=$LLVM_DEFAULT_TARGET_TRIPLE \
            -DLLVM_ENABLE_ASSERTIONS=ON \
            -DLLVM_ENABLE_PROJECTS=mlir \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DLLVM_HOST_TRIPLE=$LLVM_HOST_TRIPLE \
            -DLLVM_INCLUDE_UTILS=ON \
            -DLLVM_INSTALL_UTILS=ON \
            -DLLVM_TARGETS_TO_BUILD=$ARCH \
            -DLLVM_TARGET_ARCH=$ARCH \
            -DMLIR_BUILD_MLIR_C_DYLIB=1 \
            -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
            -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
            -DPython3_EXECUTABLE=$(which python)"
          
          echo $CMAKE_CONFIGS
          
          if [ x"${{ matrix.os }}" == x"macos-latest" ]; then
          
            cmake ${CMAKE_CONFIGS} \
              -G "$GENERATOR" \
              -DLLVM_USE_HOST_TOOLS=ON \
              -DCMAKE_OSX_ARCHITECTURES="$CMAKE_OSX_ARCHITECTURE" \
              -DMACOSX_DEPLOYMENT_TARGET=12.0 \
              -S${LLVM_PROJECT_MAIN_SRC_DIR}/llvm \
              -B${LLVM_PROJECT_MAIN_BINARY_DIR}
          
          elif [ x"${{ matrix.os }}" == x"ubuntu-20.04" ] && [ x"${{ matrix.arch }}" == x"AArch64" ]; then
          
            cmake $CMAKE_CONFIGS \
                -G "$GENERATOR" \
                -DLLVM_USE_HOST_TOOLS=ON \
                -DLLVM_TABLEGEN=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/llvm-tblgen \
                -DMLIR_LINALG_ODS_YAML_GEN=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-linalg-ods-yaml-gen \
                -DMLIR_LINALG_ODS_YAML_GEN_EXE=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-linalg-ods-yaml-gen \
                -DMLIR_PDLL_TABLEGEN=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-pdll \
                -DMLIR_TABLEGEN=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-tblgen \
                -DCMAKE_CXX_FLAGS="-O2 ${STATIC_FLAGS}" \
                -S${LLVM_PROJECT_MAIN_SRC_DIR}/llvm \
                -B${LLVM_PROJECT_MAIN_BINARY_DIR}
          
          elif [ x"${{ matrix.os }}" == x"windows-latest" ] && [ x"${{ matrix.arch }}" == x"X86" ]; then
          
            cmake $CMAKE_CONFIGS \
                -G "$GENERATOR" \
                -DCMAKE_C_FLAGS="-D_SILENCE_NONFLOATING_COMPLEX_DEPRECATION_WARNING" \
                -DCMAKE_CXX_FLAGS="-D_SILENCE_NONFLOATING_COMPLEX_DEPRECATION_WARNING" \
                -DLLVM_USE_CRT_MINSIZEREL=MT \
                -DLLVM_USE_CRT_RELEASE=MT \
                -S${LLVM_PROJECT_MAIN_SRC_DIR}/llvm \
                -B${LLVM_PROJECT_MAIN_BINARY_DIR}
          
          elif [ x"${{ matrix.os }}" == x"windows-latest" ] && [ x"${{ matrix.arch }}" == x"AArch64" ]; then
          
            cmake $CMAKE_CONFIGS \
                -G "$GENERATOR" \
                -A ARM64 -Thost=x64 \
                -DLLVM_USE_HOST_TOOLS=ON \
                -DCMAKE_C_FLAGS="-D_SILENCE_NONFLOATING_COMPLEX_DEPRECATION_WARNING" \
                -DCMAKE_CXX_FLAGS="-D_SILENCE_NONFLOATING_COMPLEX_DEPRECATION_WARNING" \
                -DLLVM_TABLEGEN=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/llvm-tblgen.exe \
                -DMLIR_LINALG_ODS_YAML_GEN=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-linalg-ods-yaml-gen.exe \
                -DMLIR_LINALG_ODS_YAML_GEN_EXE=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-linalg-ods-yaml-gen.exe \
                -DMLIR_PDLL_TABLEGEN=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-pdll.exe \
                -DMLIR_TABLEGEN=$LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-tblgen.exe \
                -DLLVM_USE_CRT_MINSIZEREL=MT \
                -DLLVM_USE_CRT_RELEASE=MT \
                -S${LLVM_PROJECT_MAIN_SRC_DIR}/llvm \
                -B${LLVM_PROJECT_MAIN_BINARY_DIR}
          
          else
          
            cmake $CMAKE_CONFIGS \
                  -G Ninja \
                  -DLLVM_USE_HOST_TOOLS=ON \
                  -S${LLVM_PROJECT_MAIN_SRC_DIR}/llvm \
                  -B${LLVM_PROJECT_MAIN_BINARY_DIR}
          
          fi

      - name: Build distro
        shell: bash
        run: |
          cd $WORKSPACE_ROOT
          cmake --build ${LLVM_PROJECT_MAIN_BINARY_DIR} --target install -j
          ccache -s

      - name: Make tarballs
        shell: bash
        run: |
          cd $WORKSPACE_ROOT
          
          if [ x"${{ matrix.arch }}" == x"AArch64" ]; then
            mkdir -p $LLVM_PROJECT_INSTALL_DIR/llvm_native_tools
            cp -L $LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-linalg-ods-yaml-gen* $LLVM_PROJECT_INSTALL_DIR/llvm_native_tools/mlir-linalg-ods-yaml-gen
            cp -L $LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-pdll* $LLVM_PROJECT_INSTALL_DIR/llvm_native_tools/mlir-pdll
            cp -L $LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/mlir-tblgen* $LLVM_PROJECT_INSTALL_DIR/llvm_native_tools/mlir-tblgen
            cp -L $LLVM_PROJECT_HOST_MAIN_BINARY_DIR/bin/llvm-tblgen* $LLVM_PROJECT_INSTALL_DIR/llvm_native_tools/llvm-tblgen
          fi
          
          OUTPUT="llvm-project-${LLVM_PROJECT_COMMIT}-${{ matrix.os }}-${{ matrix.arch }}"
          XZ_OPT='-T0 -9' tar -cJf "${OUTPUT}.tar.xz" llvm_project_install

          mkdir -p $GITHUB_WORKSPACE/${{ github.sha }}/
          mv *.tar.xz $GITHUB_WORKSPACE/${{ github.sha }}/

      - name: Checkout this repo
        uses: actions/checkout@v3
        with:
          path: this_repo

      - name: Build MLIR Python bindings wheel
        shell: bash
        run: |
          cd $GITHUB_WORKSPACE/this_repo
          
          python -m pip install wheel
          if [ x"${{ matrix.os }}" == x"macos-latest" ]; then
            PLATFORM_NAME="macosx_12_0"
            ARCH=$CMAKE_OSX_ARCHITECTURE
          elif [ x"${{ matrix.os }}" == x"windows-latest" ]; then
            PLATFORM_NAME="win"
            ARCH=amd64
          elif [ x"${{ matrix.os }}" == x"ubuntu-20.04" ] && [ x"${{ matrix.arch }}" == x"AArch64" ]; then
            PLATFORM_NAME="manylinux2014"
            ARCH=aarch64
          else
            PLATFORM_NAME="manylinux2014"
            ARCH=x86_64
          fi
          
          cp -L -R $LLVM_PROJECT_INSTALL_DIR/python_packages/mlir_core/mlir .
          cp -L -R $LLVM_PROJECT_INSTALL_DIR/lib/*mlir* mlir/_mlir_libs/
          
          python setup.py bdist_wheel --plat-name "${PLATFORM_NAME}_${ARCH}" --dist-dir $GITHUB_WORKSPACE/${{ github.sha }}

      - name: Upload an artifact
        uses: actions/upload-artifact@v3
        with:
          if-no-files-found: error
          name: build_artifact
          path: ${{ github.sha }}

  upload-tarballs:

    runs-on: ubuntu-20.04

    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: build_artifact
          path: ${{ github.sha }}

      - name: Set up a release page
        id: setup_release
        run: |
          LLVM_PROJECT_COMMIT="${{ needs.build.outputs.LLVM_PROJECT_COMMIT }}"
          echo "Created at $(date) build of [https://github.com/llvm/llvm-project/commit/${LLVM_PROJECT_COMMIT}](https://github.com/llvm/llvm-project/commit/${LLVM_PROJECT_COMMIT})" > body.md
          echo "tag_name=llvm-project-${LLVM_PROJECT_COMMIT}" | tee -a $GITHUB_OUTPUT
          echo "release_title=llvm-project-${LLVM_PROJECT_COMMIT}" | tee -a $GITHUB_OUTPUT

      - name: Release current commit
        uses: ncipollo/release-action@v1
        with:
          artifacts: "${{ github.sha }}/*.tar.xz,${{ github.sha }}/*.whl,${{ github.sha }}/*.exe"
          bodyFile: body.md
          token: "${{ secrets.GITHUB_TOKEN }}"
          tag: "${{ steps.setup_release.outputs.tag_name }}"
          name: "${{ steps.setup_release.outputs.release_title }}"
          removeArtifacts: false
          allowUpdates: true
          replacesArtifacts: true
