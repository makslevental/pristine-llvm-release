name: Build

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:
    branches:
      - main

  schedule:
    # At minute 0 past hour 1, 7, 13, and 19. (see https://crontab.guru)
    - cron: '00 01,07,13,19 * * *'

jobs:
  build:
    name: Build distro of LLVM+MLIR
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest ]
        py_version: [ "3.10" ]
    outputs:
      LLVM_PROJECT_COMMIT: ${{ steps.get_llvm_project_commit.outputs.LLVM_PROJECT_COMMIT }}
    steps:
      - name: Compute llvm-project base path
        run: |
          echo "LLVM_PROJECT_MAIN_SRC_DIR=${GITHUB_WORKSPACE}/sandbox" | tee -a $GITHUB_ENV
          echo "LLVM_PROJECT_MAIN_BINARY_DIR=${GITHUB_WORKSPACE}/sandbox/build" | tee -a $GITHUB_ENV
          echo "LLVM_PROJECT_INSTALL_DIR=${GITHUB_WORKSPACE}/llvm_project_install" | tee -a $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # v4.3.0
        with:
          python-version: ${{ matrix.py_version }}

      - name: Checkout llvm-project
        uses: actions/checkout@v3
        with:
          repository: llvm/llvm-project
          path: sandbox
          submodules: recursive

      - name: Get llvm-project commit
        id: get_llvm_project_commit
        run: |
          cd $LLVM_PROJECT_MAIN_SRC_DIR
          LLVM_PROJECT_COMMIT=$(git rev-parse --short HEAD)
          echo "LLVM_PROJECT_COMMIT=${LLVM_PROJECT_COMMIT}" | tee -a $GITHUB_ENV
          echo "LLVM_PROJECT_COMMIT=${LLVM_PROJECT_COMMIT}" | tee -a $GITHUB_OUTPUT

      - name: Install Python depends
        run: |
          python -m pip install -r ${LLVM_PROJECT_MAIN_SRC_DIR}/mlir/python/requirements.txt

      - name: Install Ninja
        uses: llvm/actions/install-ninja@6a57890d0e3f9f35dfc72e7e48bc5e1e527cdd6c # Jan 17

      - name: Ccache for C++ compilation
        uses: hendrikmuhs/ccache-action@621a41397ed83711c72862638d9ff6e63fca3041 # v1.2.3
        with:
          key: ${{ runner.os }}-llvm-project
          # LLVM needs serious cache size
          max-size: 6G

      - name: Configure CMake
        run: |
          CMAKE_CONFIGS="\
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_INSTALL_PREFIX=$LLVM_PROJECT_INSTALL_DIR \
            -DLLVM_CCACHE_BUILD=ON \
            -DLLVM_ENABLE_ASSERTIONS=ON \
            -DCMAKE_LINKER=lld \
            -DLLVM_ENABLE_PROJECTS=mlir \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DLLVM_INCLUDE_UTILS=ON \
            -DLLVM_INSTALL_UTILS=ON \
            -DLLVM_USE_HOST_TOOLS=ON \
            -DMLIR_BUILD_MLIR_C_DYLIB=1 \
            -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
            -DMLIR_ENABLE_EXECUTION_ENGINE=ON \
            -DPython3_EXECUTABLE=$(which python)"
          
          if [ x"${{ matrix.os }}" == x"macos-latest" ]; then
            CMAKE_CONFIGS="${CMAKE_CONFIGS} \
              -DCMAKE_OSX_ARCHITECTURES=arm64 \
              -DLLVM_TARGET_ARCH=AArch64 \
              -DLLVM_TARGETS_TO_BUILD=AArch64 \
              -DMACOSX_DEPLOYMENT_TARGET=12.0"
          else
            CMAKE_CONFIGS="${CMAKE_CONFIGS} \
              -DLLVM_TARGET_ARCH=X86 \
              -DLLVM_TARGETS_TO_BUILD=X86"
          fi
          
          cmake -G Ninja \
                $CMAKE_CONFIGS \
                -S${LLVM_PROJECT_MAIN_SRC_DIR}/llvm \
                -B${LLVM_PROJECT_MAIN_BINARY_DIR}

      - name: Build distro
        run: |
          cmake --build ${LLVM_PROJECT_MAIN_BINARY_DIR} --target install
          ccache -s

      - name: Make tarballs
        run: |
          OUTPUT="llvm-project-${LLVM_PROJECT_COMMIT}-${{ matrix.os }}"
          cd "$LLVM_PROJECT_INSTALL_DIR"/..
          XZ_OPT='-T0 -9' tar -cJf "${OUTPUT}.tar.xz" llvm_project_install

          mkdir -p ${{ github.sha }}/
          mv *.tar.xz ${{ github.sha }}/

      - name: Build MLIR Python bindings wheel
#        if: matrix.config == 'release'
        run: |
          if [ x"${{ matrix.os }}" == x"ubuntu-latest" ]; then
            R=r
          else
            R=R
          fi
          
          cp -L -$R llvm_project_install/python_packages/mlir_core/mlir .
          pip install cibuildwheel
          cibuildwheel
          mv wheelhouse/mlir-python-bindings*.whl ${{ github.sha }}/

      - name: Upload an artifact
        uses: actions/upload-artifact@v3
        with:
          if-no-files-found: error
          name: build_artifact
          path: ${{ github.sha }}

  upload-tarballs:

    runs-on: ubuntu-latest

    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: build_artifact
          path: ${{ github.sha }}

      - name: Set up a release page
        id: setup_release
        run: |
          LLVM_PROJECT_COMMIT="${{ needs.build.outputs.LLVM_PROJECT_COMMIT }}"
          echo "Created at $(date) build of [https://github.com/llvm/llvm-project/commit/${LLVM_PROJECT_COMMIT}](https://github.com/llvm/llvm-project/commit/${LLVM_PROJECT_COMMIT})" > body.md
          echo "tag_name=llvm-project-${LLVM_PROJECT_COMMIT}" | tee -a $GITHUB_OUTPUT
          echo "release_title=llvm-project-${LLVM_PROJECT_COMMIT}" | tee -a $GITHUB_OUTPUT

      - name: Release current commit
        uses: ncipollo/release-action@v1
        with:
          artifacts: "${{ github.sha }}/*.tar.xz,${{ github.sha }}/*.whl,${{ github.sha }}/*.exe"
          bodyFile: body.md
          token: "${{ secrets.GITHUB_TOKEN }}"
          tag: "${{ steps.setup_release.outputs.tag_name }}"
          name: "${{ steps.setup_release.outputs.release_title }}"
          removeArtifacts: false
          allowUpdates: true
          replacesArtifacts: true
